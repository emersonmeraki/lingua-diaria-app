<!DOCTYPE html>
<html lang="pt-BR" class=""> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Língua Diária - Aprenda Inglês Todos os Dias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body {
            background-color: #1f2937;
            color: #d1d5db;
        }
        .dark .card {
            background-color: #374151;
            border-color: #4b5563;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }
        .dark .text-gray-800 { color: #d1d5db; } 
        .dark .text-gray-700 { color: #9ca3af; } 
        .dark .text-gray-600 { color: #cbd5e1; } 
        .dark .text-gray-500 { color: #a1a1aa; } 
        .dark .text-indigo-600 { color: #a5b4fc; } 
        .dark .text-indigo-700 { color: #818cf8; } 
        .dark .hover\:text-indigo-800:hover { color: #6366f1; } 
        .dark .bg-white { background-color: #374151; } 
        .dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5), 0 2px 4px -1px rgba(0,0,0,0.3); }
        .dark .border-yellow-300 { border-color: #fcd34d; } 
        .dark .bg-yellow-100 { background-color: #4f4629; } 
        .dark .text-yellow-700 { color: #fef08a; } 
        .dark .bg-green-100 { background-color: #224b3b; }
        .dark .text-green-700 { color: #6ee7b7; }
        .dark .border-green-300 { border-color: #34d399; }
        .dark .bg-red-100 { background-color: #5f2120; }
        .dark .text-red-700 { color: #fca5a5; }
        .dark .border-red-300 { border-color: #f87171; }
        .dark .bg-blue-100 { background-color: #1e3a8a; }
        .dark .text-blue-700 { color: #93c5fd; }
        .dark .border-blue-300 { border-color: #60a5fa; }
        .dark .bg-purple-100 { background-color: #581c87; }
        .dark .text-purple-700 { color: #d8b4fe; }
        .dark .border-purple-300 { border-color: #c084fc; }
        .dark .header-subtitle { color: #e5e7eb; } 
        .dark .footer-text { color: #9ca3af; } 

        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        @media (min-width: 640px) {
            .card {
                margin-bottom: 2rem;
            }
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease, opacity 0.3s ease;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background-color: #4f46e5; 
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca; 
        }
        .btn:disabled { /* Estilo geral para botões desabilitados */
            background-color: #a5b4fc; 
            color: #e0e7ff;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .dark .btn:disabled {
            background-color: #6b7280; 
            color: #9ca3af;
        }
        .btn-secondary {
            background-color: #e0e7ff; 
            color: #3730a3; 
        }
        .btn-secondary:hover:not(:disabled) { /* Hover apenas se não estiver desabilitado */
            background-color: #c7d2fe; 
        }
        .dark .btn-secondary {
            background-color: #4338ca; 
            color: #e0e7ff; 
        }
        .dark .btn-secondary:hover:not(:disabled) {
            background-color: #4f46e5; 
        }


        .progress-section-container {
            position: relative;
        }
        .progress-bar-wrapper {
            width: 100%;
            background-color: #e5e7eb; 
            border-radius: 0.75rem;
            overflow: hidden;
            height: 2rem;
            position: relative;
        }
        .dark .progress-bar-wrapper {
            background-color: #4b5563; 
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, #4f46e5 0%, #818cf8 100%);
            height: 100%;
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            position: relative;
            z-index: 1;
        }
        .progress-bar-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background-color: #ffffff;
            border: 3px solid #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            left: 0%;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .dark .progress-bar-icon {
            background-color: #e0e7ff; 
            border-color: #818cf8;
        }
        .progress-bar-icon svg {
            width: 16px;
            height: 16px;
            fill: #4f46e5;
        }
        .dark .progress-bar-icon svg {
            fill: #4338ca;
        }

        /* Container para o conteúdo da lição (vídeo de intro ou botão para abrir aula) */
        .content-container {
            position: relative;
            overflow: hidden; 
            max-width: 100%;
            background: #e2e8f0; 
            border-radius: 0.5rem;
            min-height: 150px; /* Altura mínima para botão/placeholder */
            display: flex; /* Para centralizar o botão "Abrir Aula" */
            align-items: center;
            justify-content: center;
        }
        .dark .content-container {
            background: #4b5563; 
        }
        .content-container iframe, /* Para vídeo de introdução */
        .content-container img { /* Para placeholder de carregamento */
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            border-radius: 0.5rem; 
        }
        /* Botão para abrir a aula no modal */
        #open-lesson-in-modal-button {
            padding: 0.75rem 2rem;
        }

        /* Modal para Tela Cheia da Aula */
        #lesson-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #lesson-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #lesson-modal-content-wrapper {
            width: 100%;
            height: 100%;
            max-width: 100vw; /* Garante que não exceda a largura da viewport */
            max-height: 100vh; /* Garante que não exceda a altura da viewport */
        }
        #modal-lesson-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
        }


        .file-input-label {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            background-color: #10b981; 
            color: white;
            cursor: pointer;
            display: inline-block;
            transition: background-color 0.3s ease;
        }
        .file-input-label:hover {
            background-color: #059669; 
        }
        .dark .file-input-label {
            background-color: #059669; 
        }
        .dark .file-input-label:hover {
            background-color: #047857; 
        }
        #import-progress-input {
            display: none;
        }
        .action-buttons-container { /* Container para botões Exportar/Importar */
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }
        @media (min-width: 640px) {
            .action-buttons-container {
                flex-direction: row;
                justify-content: center;
                gap: 0.75rem;
            }
        }
        /* Container para botões de controle da lição (Anterior, Concluir) */
        .lesson-controls-container {
            display: flex;
            flex-wrap: wrap; /* Permite que os botões quebrem linha em telas menores */
            justify-content: center;
            gap: 0.5rem; /* Espaçamento entre botões */
            margin-top: 1rem; /* Espaço acima dos botões de controle */
        }


        .quote-author {
            font-size: 0.875rem; 
            color: #4b5563; 
            margin-top: 0.25rem; 
            text-align: right;
        }
        .dark .quote-author {
            color: #9ca3af; 
        }

        .whatsapp-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center; 
        }
        .whatsapp-callout {
            background-color: #075E54; 
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem; 
            margin-bottom: 12px; 
            white-space: nowrap;
            position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0; 
            transform: translateY(10px); 
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none; 
        }
        .whatsapp-container:hover .whatsapp-callout { 
            opacity: 1;
            transform: translateY(0);
        }
        .dark .whatsapp-callout {
            background-color: #128C7E; 
        }
        .whatsapp-callout::after { 
            content: "";
            position: absolute;
            top: 100%; 
            left: 50%;
            transform: translateX(-50%);
            border-width: 7px;
            border-style: solid;
            border-color: #075E54 transparent transparent transparent; 
        }
        .dark .whatsapp-callout::after {
            border-color: #128C7E transparent transparent transparent;
        }

        .whatsapp-fab {
            background-color: #25D366;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        .whatsapp-fab:hover {
            background-color: #1DAE52;
            transform: scale(1.1);
        }
        .whatsapp-fab svg {
            width: 32px;
            height: 32px;
            fill: white;
        }
       
        .header-actions button, .header-actions a {
            background: none; border: none; cursor: pointer; padding: 0.5rem;
            border-radius: 0.375rem; transition: background-color 0.2s ease-in-out;
            color: #4b5563; 
        }
        .dark .header-actions button, .dark .header-actions a { color: #d1d5db; }
        .header-actions button:hover, .header-actions a:hover { background-color: rgba(0,0,0,0.1); }
        .dark .header-actions button:hover, .dark .header-actions a:hover { background-color: rgba(255,255,255,0.1); }
        .header-actions svg { width: 24px; height: 24px; fill: currentColor; }
        .dark .bg-gray-800 { background-color: #111827; } 
        .dark .text-white { color: #f3f4f6; } 

        .header-subtitle {
            font-size: 0.875rem; color: #4b5563; text-align: center; 
        }
        @media (min-width: 640px) { .header-subtitle { text-align: left; } }
        .footer-text { font-size: 0.875rem; color: #6b7280; }

    </style>
</head>
<body class="text-gray-800 antialiased">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-indigo-600 text-center sm:text-left">Língua Diária</h1>
                    <p class="header-subtitle mt-1">Fazendo você aprender com dedicação, paixão e carinho.</p>
                </div>
                <div class="header-actions flex items-center space-x-2 mt-2 sm:mt-0">
                    <a href="https://www.youtube.com" target="_blank" rel="noopener noreferrer" aria-label="Nosso Canal no YouTube" title="Canal no YouTube">
                        <svg viewBox="0 0 24 24"> <path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.25,4,12,4,12,4S5.75,4,4.186,4.418 c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.75,2,12,2,12s0,4.25,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.75,20,12,20,12,20s6.25,0,7.814-0.418c0.861-0.23,1.538-0.908,1.768-1.768C22,16.25,22,12,22,12S22,7.75,21.582,6.186z M9.996,15.006V8.994l5.217,3.006L9.996,15.006z"/>
                        </svg>
                    </a>
                    <button id="theme-toggle" aria-label="Alternar tema" title="Alternar Tema">
                        <svg id="theme-toggle-dark-icon" class="hidden" viewBox="0 0 24 24"> <path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path>
                        </svg>
                        <svg id="theme-toggle-light-icon" class="hidden" viewBox="0 0 24 24"> <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 sm:px-6 py-6 sm:py-8">

        <section id="motivation-section" class="card">
            <h2 class="text-lg sm:text-xl font-semibold mb-3 text-gray-700">Frase do Dia</h2>
            <blockquote id="quote-container">
                <p id="quote-text" class="text-base sm:text-lg italic text-gray-600 mb-1">Carregando frase...</p>
                <p id="quote-author" class="quote-author mb-2 hidden"></p> 
            </blockquote>
            <p id="quote-translation" class="text-sm text-gray-500 mb-3 hidden"></p>
            <button id="translate-button" class="btn btn-secondary text-sm">Mostrar Tradução</button>
        </section>

        <section id="progress-section" class="card progress-section-container">
            <h2 class="text-lg sm:text-xl font-semibold mb-3 text-gray-700">Seu Progresso de Aprendizado</h2>
            <div class="progress-bar-wrapper mb-2">
                <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;">0%</div>
                <div id="progress-bar-icon" class="progress-bar-icon" style="left: 0%;">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                </div>
            </div>
            <p id="progress-text" class="text-center text-sm sm:text-base text-gray-600">Complete a introdução para começar!</p>
            <div class="mt-4 action-buttons-container">
                <button id="export-progress-button" class="btn btn-secondary text-sm w-full sm:w-auto">Exportar Progresso (JSON)</button>
                <label for="import-progress-input" class="btn btn-secondary text-sm file-input-label w-full sm:w-auto">Importar Progresso (JSON)</label>
                <input type="file" id="import-progress-input" accept=".json">
            </div>
        </section>

        <main id="lesson-area" class="card">
            <h2 id="lesson-title" class="text-xl sm:text-2xl font-bold mb-4 text-indigo-700">Carregando...</h2>
            
            <div id="lesson-content-area" class="mb-6">
                <div id="lesson-content-embed" class="content-container mb-4">
                    <img src="https://placehold.co/1600x900/e2e8f0/64748b?text=Carregando+Conte%C3%BAdo..." alt="Carregando conteúdo" class="w-full h-full object-cover">
                </div>
                <div id="lesson-materials-container" class="mb-4 hidden">
                    <h3 class="text-base sm:text-lg font-semibold mb-2 text-gray-700">Recursos Adicionais:</h3>
                    <a id="lesson-materials-link" href="#" target="_blank" class="text-indigo-600 hover:text-indigo-800 hover:underline"></a>
                </div>
            </div>

            <div id="lesson-message" class="mb-4 p-3 rounded-md hidden text-sm sm:text-base"></div>
            
            <div class="lesson-controls-container">
                <button id="previous-lesson-button" class="btn btn-secondary w-full sm:w-auto">Aula Anterior</button>
                <button id="complete-lesson-button" class="btn btn-primary w-full sm:w-auto">Marcar como Concluída</button>
            </div>
            <p id="course-completed-message" class="mt-4 text-green-600 font-semibold hidden">Parabéns! Você concluiu todas as aulas de aprendizado!</p>
        </main>
    </div>

    <footer class="mt-12 py-8 bg-gray-800 text-white text-center">
        <p class="footer-text">© <span id="currentYear"></span> Língua Diária. Todos os direitos reservados.</p>
        <p class="footer-text mt-2">Seu aprendizado é nossa maior inspiração. Continue firme!</p>
    </footer>

    <div id="lesson-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-2 sm:p-4 z-[100] hidden">
        <div id="lesson-modal-content-wrapper" class="bg-white dark:bg-gray-800 p-3 sm:p-5 rounded-lg shadow-xl w-full h-full flex flex-col">
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h3 id="modal-lesson-title" class="text-lg sm:text-xl font-bold text-indigo-700 dark:text-indigo-400 truncate pr-2"></h3>
                <button id="close-lesson-modal" aria-label="Fechar aula" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-lesson-content" class="flex-grow h-0 overflow-y-auto">
                </div>
        </div>
    </div>


    <div class="whatsapp-container">
        <span class="whatsapp-callout">Tire suas dúvidas!</span>
        <a href="https://wa.me/5574988592119" class="whatsapp-fab" target="_blank" rel="noopener noreferrer" aria-label="Fale conosco no WhatsApp">
            <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                <path d="M16.001 2.672c-7.36 0-13.328 5.968-13.328 13.328s5.968 13.328 13.328 13.328 13.328-5.968 13.328-13.328S23.361 2.672 16.001 2.672zm0 24.352c-6.08 0-11.024-4.944-11.024-11.024S9.921 4.976 16.001 4.976s11.024 4.944 11.024 11.024-4.944 11.024-11.024 11.024zm5.008-8.112c-.24-.12-.864-.432-1-.48s-.24-.072-.336.072c-.096.144-.384.48-.48.576s-.192.12-.336.048c-.144-.072-1.104-.408-2.096-1.272s-1.632-1.944-1.92-2.28c-.288-.336-.072-.504.048-.648s.144-.192.216-.288c.072-.096.096-.144.048-.24s-.336-.816-.456-.1.104c-.12-.024-.24-.024-.36-.024s-.24-.024-.36-.024c-.12 0-.312.048-.48.24s-.648.624-.648 1.512c0 .888.672 1.752.768 1.872s1.296 1.968 3.144 2.76c1.848.792 1.848.528 2.184.504s1.008-.408 1.152-.816c.144-.408.144-.744.096-.816s-.072-.12-.216-.24z" fill-rule="evenodd" clip-rule="evenodd" fill="white"/>
            </svg>
        </a>
    </div>

    <script>
        // --- CONFIGURAÇÕES ---
        const IS_DEVELOPMENT_MODE = true; 
        const TOTAL_LEARNING_DAYS = 277; 
        const APP_STORAGE_KEY = 'linguaDiariaProgress';
        const THEME_STORAGE_KEY = 'linguaDiariaTheme';
        const INTRO_VIDEO_ID = "dQw4w9WgXcQ"; 

        // --- Array de Frases Motivacionais ---
        let dailyMotivationalQuotes = [];
        dailyMotivationalQuotes[1] = { day: 1, en: "The journey of a thousand miles begins with a single step.", pt: "A jornada de mil milhas começa com um único passo.", author: "Lao Tzu" };
        dailyMotivationalQuotes[2] = { day: 2, en: "Don't watch the clock; do what it does. Keep going.", pt: "Não observe o relógio; faça o que ele faz. Continue andando.", author: "Sam Levenson" };
        for (let i = 3; i <= 277; i++) {
            if (!dailyMotivationalQuotes[i]) { 
                dailyMotivationalQuotes[i] = { 
                    day: i, 
                    en: `Motivational Quote for Day ${i} - Remember to add specific content.`, 
                    pt: `Frase Motivacional para o Dia ${i} - Lembre-se de adicionar conteúdo específico.`, 
                    author: "System Placeholder" 
                };
            }
        }
        
        // --- Dados das Lições ---
        const lessonsData = [
            { id: 'intro', type: 'intro', title: "Bem-vindo à Língua Diária!", videoId: INTRO_VIDEO_ID },
            { id: 1, type: 'interactive_page', title: "Dia 1: Os Fundamentos Essenciais", pageUrl: "aulas/dia1.html" }, 
            { id: 2, type: 'interactive_page', title: "Dia 2: Primeiras Conversas", pageUrl: "aulas/dia2.html" },
        ];
        for (let i = 3; i <= TOTAL_LEARNING_DAYS; i++) {
            lessonsData.push({
                id: i,
                type: 'interactive_page',
                title: `Dia ${i}: Tópico da Aula ${i}`, 
                pageUrl: `aulas/dia${i}.html`, 
            });
        }

        // --- ELEMENTOS DO DOM ---
        const quoteTextEl = document.getElementById('quote-text');
        const quoteAuthorEl = document.getElementById('quote-author');
        const quoteTranslationEl = document.getElementById('quote-translation');
        const translateButton = document.getElementById('translate-button');
        const progressBarFillEl = document.getElementById('progress-bar-fill');
        const progressBarIconEl = document.getElementById('progress-bar-icon');
        const progressTextEl = document.getElementById('progress-text');
        const lessonTitleEl = document.getElementById('lesson-title');
        const lessonContentEmbedEl = document.getElementById('lesson-content-embed');
        const lessonMaterialsContainerEl = document.getElementById('lesson-materials-container'); // Não usado atualmente
        const lessonMaterialsLinkEl = document.getElementById('lesson-materials-link'); // Não usado atualmente
        const completeLessonButton = document.getElementById('complete-lesson-button');
        const previousLessonButton = document.getElementById('previous-lesson-button'); // Novo botão
        const lessonMessageEl = document.getElementById('lesson-message');
        const courseCompletedMessageEl = document.getElementById('course-completed-message');
        const currentYearEl = document.getElementById('currentYear');
        const exportProgressButton = document.getElementById('export-progress-button');
        const importProgressInput = document.getElementById('import-progress-input');
        const themeToggleButton = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // Elementos do Modal da Lição
        const lessonModalEl = document.getElementById('lesson-modal');
        const modalLessonTitleEl = document.getElementById('modal-lesson-title');
        const modalLessonContentEl = document.getElementById('modal-lesson-content');
        const closeLessonModalButtonEl = document.getElementById('close-lesson-modal');


        // --- ESTADO DA APLICAÇÃO ---
        let currentQuoteObject = null;
        let translationVisible = false;
        let userProgress = {
            introCompleted: false,
            currentLearningDay: 1, 
            lastActivityDate: null 
        };
        let currentLessonData = null; // Para armazenar dados da lição atual para o modal

        // --- FUNÇÕES ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');  
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.add('hidden');   
                themeToggleLightIcon.classList.remove('hidden');
            }
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem(THEME_STORAGE_KEY);
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem(THEME_STORAGE_KEY, newTheme);
            applyTheme(newTheme);
        }
        
        function loadTheme() {
            const preferredTheme = localStorage.getItem(THEME_STORAGE_KEY);
            if (preferredTheme) {
                applyTheme(preferredTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            }
            else {
                applyTheme('light'); 
            }
        }

        function displayDailyQuote() {
            let quoteToDisplay;
            if (!userProgress.introCompleted) {
                quoteToDisplay = { en: "Welcome! Complete the intro to begin your daily quotes.", pt: "Bem-vindo! Complete a introdução para começar suas frases diárias.", author: "Língua Diária" };
            } else if (userProgress.currentLearningDay > TOTAL_LEARNING_DAYS) {
                quoteToDisplay = { en: "Congratulations on completing your learning journey!", pt: "Parabéns por completar sua jornada de aprendizado!", author: "Língua Diária" };
            } else if (userProgress.currentLearningDay >= 1 && 
                       userProgress.currentLearningDay < dailyMotivationalQuotes.length && 
                       dailyMotivationalQuotes[userProgress.currentLearningDay] && 
                       dailyMotivationalQuotes[userProgress.currentLearningDay].en) {
                quoteToDisplay = dailyMotivationalQuotes[userProgress.currentLearningDay];
            } else {
                console.warn(`Quote for day ${userProgress.currentLearningDay} not found. Using placeholder.`);
                quoteToDisplay = {
                    en: `English Quote for Day ${userProgress.currentLearningDay} - (Content missing)`,
                    pt: `Tradução para o Dia ${userProgress.currentLearningDay} - (Conteúdo ausente)`,
                    author: "Sistema"
                };
            }
            currentQuoteObject = quoteToDisplay;
            quoteTextEl.textContent = `"${currentQuoteObject.en}"`;
            if (currentQuoteObject.author) {
                quoteAuthorEl.textContent = `- ${currentQuoteObject.author}`;
                quoteAuthorEl.classList.remove('hidden');
            } else {
                quoteAuthorEl.classList.add('hidden');
            }
            quoteTranslationEl.textContent = currentQuoteObject.pt;
            quoteTranslationEl.classList.add('hidden');
            translateButton.textContent = 'Mostrar Tradução';
            translationVisible = false;
        }

        function toggleTranslation() {
            translationVisible = !translationVisible;
            quoteTranslationEl.classList.toggle('hidden', !translationVisible);
            translateButton.textContent = translationVisible ? 'Ocultar Tradução' : 'Mostrar Tradução';
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem(APP_STORAGE_KEY);
            if (savedProgress) {
                try {
                    const parsedProgress = JSON.parse(savedProgress);
                    if (typeof parsedProgress.introCompleted === 'boolean' &&
                        typeof parsedProgress.currentLearningDay === 'number' &&
                        parsedProgress.currentLearningDay >= 1 &&
                        (parsedProgress.lastActivityDate === null || (typeof parsedProgress.lastActivityDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(parsedProgress.lastActivityDate)))
                       ) {
                        userProgress = parsedProgress;
                    } else {
                        console.warn("Progresso salvo inválido. Usando padrão.");
                        saveProgress();
                    }
                } catch (error) {
                    console.error("Erro ao carregar progresso:", error);
                }
            }
        }

        function saveProgress() {
            localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(userProgress));
        }

        function updateProgressBar() {
            let daysEffectivelyCompleted = 0;
            if (userProgress.introCompleted) {
                daysEffectivelyCompleted = Math.max(0, userProgress.currentLearningDay - 1);
            }
            const percentage = userProgress.introCompleted ? Math.min(100, (daysEffectivelyCompleted / TOTAL_LEARNING_DAYS) * 100) : 0;
            progressBarFillEl.style.width = `${percentage}%`;
            progressBarFillEl.textContent = `${Math.floor(percentage)}%`;
            let iconLeftPercentage;
            if (percentage >= 97) {
                iconLeftPercentage = `calc(100% - 28px)`; 
            } else if (percentage < 3 && percentage > 0) {
                 iconLeftPercentage = `0%`;
            } else {
                iconLeftPercentage = `${percentage}%`;
            }
            progressBarIconEl.style.left = iconLeftPercentage;

            if (!userProgress.introCompleted) {
                progressTextEl.textContent = "Complete a introdução para iniciar sua jornada!";
            } else if (daysEffectivelyCompleted >= TOTAL_LEARNING_DAYS) {
                progressTextEl.textContent = `Parabéns! Você concluiu todos os ${TOTAL_LEARNING_DAYS} dias de aprendizado!`;
                progressBarIconEl.style.left = `calc(100% - 28px)`;
            } else {
                progressTextEl.textContent = `Dia ${daysEffectivelyCompleted} de ${TOTAL_LEARNING_DAYS} concluídos. Próxima aula: Dia ${userProgress.currentLearningDay}.`;
            }
        }
        
        function getTodayDateString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        // Função para abrir a lição no modal
        function openLessonModal(lesson) {
            if (!lesson || !lesson.pageUrl) {
                console.error("Dados da lição ou URL da página ausentes para o modal.");
                modalLessonContentEl.innerHTML = `<p class="p-4 text-center text-red-600 dark:text-red-400">Erro ao carregar conteúdo da aula.</p>`;
                modalLessonTitleEl.textContent = "Erro";
                lessonModalEl.classList.remove('hidden');
                setTimeout(() => lessonModalEl.classList.remove('opacity-0'), 10); // Força reflow para transição
                return;
            }
            currentLessonData = lesson; // Armazena dados da lição atual
            modalLessonTitleEl.textContent = lesson.title;
            const pageUrlWithCacheBuster = IS_DEVELOPMENT_MODE ? `${lesson.pageUrl}?t=${new Date().getTime()}` : lesson.pageUrl;
            modalLessonContentEl.innerHTML = `<iframe src="${pageUrlWithCacheBuster}" title="${lesson.title}"></iframe>`;
            lessonModalEl.classList.remove('hidden');
            setTimeout(() => lessonModalEl.classList.remove('opacity-0'), 10); 
        }

        // Função para fechar o modal da lição
        function closeLessonModal() {
            lessonModalEl.classList.add('opacity-0');
            setTimeout(() => {
                lessonModalEl.classList.add('hidden');
                modalLessonContentEl.innerHTML = ''; // Limpa o iframe para parar vídeos/áudios
                currentLessonData = null; // Limpa dados da lição atual
            }, 300); // Tempo da transição de opacidade
        }


        function loadLessonContentUI(lesson) {
            lessonTitleEl.textContent = lesson.title;
            lessonContentEmbedEl.innerHTML = ''; // Limpa conteúdo anterior (botão ou iframe de intro)

            // Reseta estilos do container para cada tipo de conteúdo
            lessonContentEmbedEl.style.paddingBottom = '';
            lessonContentEmbedEl.style.height = '';
            // lessonContentEmbedEl.style.overflow = 'hidden'; // Removido para permitir que o botão seja clicável

            if (lesson.type === 'intro') {
                // Estilo para vídeo de introdução (mantém aspect ratio 16:9)
                lessonContentEmbedEl.style.paddingBottom = '56.25%'; 
                lessonContentEmbedEl.style.height = '0'; 

                if (lesson.videoId && lesson.videoId !== "your_youtube_intro_video_id" && !lesson.videoId.startsWith("placeholder")) {
                    lessonContentEmbedEl.innerHTML = `<iframe src="https://www.youtube.com/watch?v=1_eKyE_mHrg&pp=0gcJCdgAo7VqN5tD{lesson.videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen title="${lesson.title}"></iframe>`;
                } else {
                    lessonContentEmbedEl.innerHTML = `<img src="https://placehold.co/1600x900/e2e8f0/64748b?text=Configure+o+V%C3%ADdeo+de+Introdu%C3%A7%C3%A3o" alt="Vídeo de introdução" class="w-full h-full object-cover rounded-md">`;
                }
            } else if (lesson.type === 'interactive_page') {
                lessonContentEmbedEl.style.height = 'auto'; // Altura automática para acomodar o botão
                if (lesson.pageUrl) {
                    // Cria um botão para abrir a aula no modal
                    const openButton = document.createElement('button');
                    openButton.id = 'open-lesson-in-modal-button';
                    openButton.className = 'btn btn-primary';
                    openButton.textContent = `Abrir ${lesson.title}`;
                    openButton.onclick = () => openLessonModal(lesson);
                    lessonContentEmbedEl.appendChild(openButton);
                } else {
                    lessonContentEmbedEl.innerHTML = `<p class="p-4 text-center">Conteúdo da página interativa não configurado (pageUrl ausente para o dia ${lesson.id}).</p>`;
                }
            }

            // Materiais adicionais não são mais usados, então o container fica escondido
            lessonMaterialsContainerEl.classList.add('hidden');
        }

        function manageLessonDisplayAndControls() {
            lessonMessageEl.classList.add('hidden');
            lessonMessageEl.textContent = '';
            courseCompletedMessageEl.classList.add('hidden');
            completeLessonButton.classList.remove('hidden');
            completeLessonButton.disabled = false; 
            previousLessonButton.classList.remove('hidden'); // Mostra o botão de aula anterior

            let currentLessonToShow;
            let lessonIdentifier; 

            if (!userProgress.introCompleted) {
                currentLessonToShow = lessonsData.find(l => l.id === 'intro');
                lessonIdentifier = 'intro';
                completeLessonButton.textContent = "Concluir Introdução";
                previousLessonButton.disabled = true; // Desabilita "Aula Anterior" na introdução
            } else {
                if (userProgress.currentLearningDay > TOTAL_LEARNING_DAYS) {
                    lessonTitleEl.textContent = "Jornada Concluída!";
                    lessonContentEmbedEl.innerHTML = '<div class="p-4 text-center"><p class="text-lg text-green-600 dark:text-green-400">Fantástico! Você dominou todos os dias de aprendizado!</p><p class="mt-2 text-gray-700 dark:text-gray-300">Continue praticando para solidificar seu conhecimento.</p></div>';
                    lessonContentEmbedEl.style.paddingBottom = '0'; 
                    lessonContentEmbedEl.style.height = 'auto'; 
                    completeLessonButton.classList.add('hidden');
                    previousLessonButton.classList.add('hidden'); // Esconde "Aula Anterior" se o curso estiver completo
                    courseCompletedMessageEl.classList.remove('hidden');
                    updateProgressBar();
                    return;
                }
                currentLessonToShow = lessonsData.find(l => l.id === userProgress.currentLearningDay && l.type === 'interactive_page');
                lessonIdentifier = userProgress.currentLearningDay;
                completeLessonButton.textContent = `Marcar Dia ${userProgress.currentLearningDay} como Concluído`;
                // Habilita/desabilita "Aula Anterior"
                previousLessonButton.disabled = userProgress.currentLearningDay <= 1;
            }

            if (!currentLessonToShow) {
                lessonTitleEl.textContent = "Erro de Aula";
                lessonContentEmbedEl.innerHTML = `<p class='p-4 text-center text-red-600 dark:text-red-400'>Oops! Aula para '${lessonIdentifier}' não encontrada. Por favor, verifique.</p>`;
                lessonContentEmbedEl.style.paddingBottom = '0';
                lessonContentEmbedEl.style.height = 'auto'; 
                completeLessonButton.classList.add('hidden');
                previousLessonButton.disabled = true;
                return;
            }

            loadLessonContentUI(currentLessonToShow);

            const todayStr = getTodayDateString();
            if (userProgress.lastActivityDate === todayStr && !IS_DEVELOPMENT_MODE) {
                let message = "";
                if (lessonIdentifier === 'intro' && userProgress.introCompleted) { 
                     message = `Introdução concluída hoje! Volte amanhã para iniciar o Dia 1.`;
                } 
                else if (lessonIdentifier !== 'intro' && userProgress.currentLearningDay > 1) { 
                    const previousDayCompleted = userProgress.currentLearningDay -1; // Dia que foi completado
                    message = `Você já completou a atividade de hoje (Dia ${previousDayCompleted}). Volte amanhã para o Dia ${userProgress.currentLearningDay}!`;
                }
                if (message) {
                    lessonMessageEl.textContent = message;
                    lessonMessageEl.className = 'mb-4 p-3 bg-blue-100 text-blue-700 border border-blue-300 rounded-md text-sm sm:text-base dark:bg-blue-800 dark:text-blue-200 dark:border-blue-600';
                    lessonMessageEl.classList.remove('hidden');
                    completeLessonButton.disabled = true;
                    completeLessonButton.textContent = "Volte Amanhã";
                    // Não desabilitar o previousLessonButton aqui, pois o usuário pode querer rever
                }
            } else if (IS_DEVELOPMENT_MODE && userProgress.lastActivityDate === todayStr) {
                lessonMessageEl.textContent = `(Modo de Teste) Atividade diária já registrada para ${todayStr}, mas você pode continuar.`;
                lessonMessageEl.className = 'mb-4 p-3 bg-purple-100 text-purple-700 border border-purple-300 rounded-md text-sm sm:text-base dark:bg-purple-800 dark:text-purple-200 dark:border-purple-600';
                lessonMessageEl.classList.remove('hidden');
            }
        }
        
        // Função para lidar com o clique no botão "Aula Anterior"
        function handlePreviousLesson() {
            if (!userProgress.introCompleted || userProgress.currentLearningDay <= 1) {
                // Não faz nada se estiver na introdução ou no primeiro dia após a introdução
                return;
            }
            if (userProgress.currentLearningDay > 1) {
                userProgress.currentLearningDay -= 1;
                // Não é necessário mudar lastActivityDate ao voltar, apenas ao completar
                saveProgress();
                displayDailyQuote(); // A citação deve ser do dia atual, não do anterior
                updateProgressBar();
                manageLessonDisplayAndControls();
            }
        }


        function handleCompleteLesson() {
            const todayStr = getTodayDateString();
            lessonMessageEl.className = 'mb-4 p-3 border rounded-md text-sm sm:text-base hidden'; 
            if (userProgress.lastActivityDate === todayStr && !IS_DEVELOPMENT_MODE) {
                lessonMessageEl.textContent = `Você só pode completar uma atividade por dia. Volte amanhã!`;
                lessonMessageEl.classList.add('bg-yellow-100', 'text-yellow-700', 'border-yellow-300', 'dark:bg-yellow-700', 'dark:text-yellow-200', 'dark:border-yellow-500');
                lessonMessageEl.classList.remove('hidden');
                completeLessonButton.disabled = true;
                return;
            }
            let messageAfterCompletion = "";
            if (!userProgress.introCompleted) {
                userProgress.introCompleted = true;
                messageAfterCompletion = `Introdução concluída!`;
                if (IS_DEVELOPMENT_MODE) {
                    messageAfterCompletion += ` (Modo de Teste) Próxima aula (Dia 1) já está disponível.`;
                } else {
                    messageAfterCompletion += ` Você está pronto para começar o Dia 1.`;
                }
            } else { 
                if (userProgress.currentLearningDay <= TOTAL_LEARNING_DAYS) {
                    const dayJustCompleted = userProgress.currentLearningDay;
                    userProgress.currentLearningDay += 1; 
                    if (dayJustCompleted >= TOTAL_LEARNING_DAYS) { 
                        messageAfterCompletion = `Parabéns! Dia ${dayJustCompleted} concluído. Você finalizou todas as aulas de aprendizado!`;
                    } else { 
                        messageAfterCompletion = `Dia ${dayJustCompleted} concluído!`;
                        if (IS_DEVELOPMENT_MODE) {
                            messageAfterCompletion += ` (Modo de Teste) Próxima aula (Dia ${userProgress.currentLearningDay}) já está disponível.`;
                        } else {
                            messageAfterCompletion += ` Volte amanhã para o Dia ${userProgress.currentLearningDay}.`;
                        }
                    }
                }
            }
            if (messageAfterCompletion) {
                lessonMessageEl.textContent = messageAfterCompletion;
                lessonMessageEl.classList.add('bg-green-100', 'text-green-700', 'border-green-300', 'dark:bg-green-800', 'dark:text-green-200', 'dark:border-green-600');
                lessonMessageEl.classList.remove('hidden');
            }
            userProgress.lastActivityDate = todayStr; 
            saveProgress();
            displayDailyQuote(); 
            updateProgressBar(); 
            manageLessonDisplayAndControls(); 
        }

        function exportProgress() {
            const progressJson = JSON.stringify(userProgress, null, 2);
            const blob = new Blob([progressJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lingua_diaria_progresso.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            lessonMessageEl.textContent = "Seu progresso foi exportado como 'lingua_diaria_progresso.json'. Guarde este arquivo!";
            lessonMessageEl.className = 'mb-4 p-3 bg-green-100 text-green-700 border border-green-300 rounded-md text-sm sm:text-base dark:bg-green-800 dark:text-green-200 dark:border-green-600';
            lessonMessageEl.classList.remove('hidden');
        }

        function importProgress(event) {
            const file = event.target.files[0];
            lessonMessageEl.className = 'mb-4 p-3 border rounded-md text-sm sm:text-base hidden';
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedProgress = JSON.parse(e.target.result);
                    if (typeof importedProgress.introCompleted === 'boolean' &&
                        typeof importedProgress.currentLearningDay === 'number' &&
                        importedProgress.currentLearningDay >= 1 &&
                        importedProgress.currentLearningDay <= (TOTAL_LEARNING_DAYS + 1) && 
                        (importedProgress.lastActivityDate === null || (typeof importedProgress.lastActivityDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(importedProgress.lastActivityDate)))
                       ) {
                        userProgress = importedProgress;
                        saveProgress();
                        displayDailyQuote();
                        updateProgressBar();
                        manageLessonDisplayAndControls();
                        lessonMessageEl.textContent = "Progresso importado com sucesso!";
                        lessonMessageEl.classList.add('bg-green-100', 'text-green-700', 'border-green-300', 'dark:bg-green-800', 'dark:text-green-200', 'dark:border-green-600');
                    } else {
                        lessonMessageEl.textContent = "Arquivo de progresso inválido ou corrompido.";
                        lessonMessageEl.classList.add('bg-red-100', 'text-red-700', 'border-red-300', 'dark:bg-red-800', 'dark:text-red-200', 'dark:border-red-600');
                    }
                } catch (error) {
                    console.error("Erro ao importar progresso:", error);
                    lessonMessageEl.textContent = "Erro ao ler o arquivo de progresso: " + error.message;
                    lessonMessageEl.classList.add('bg-red-100', 'text-red-700', 'border-red-300', 'dark:bg-red-800', 'dark:text-red-200', 'dark:border-red-600');
                } finally {
                    lessonMessageEl.classList.remove('hidden');
                    importProgressInput.value = ""; 
                }
            };
            reader.readAsText(file);
        }

        function initApp() {
            currentYearEl.textContent = new Date().getFullYear();
            
            loadTheme(); 
            themeToggleButton.addEventListener('click', toggleTheme);

            translateButton.addEventListener('click', toggleTranslation);
            
            loadProgress(); 
            displayDailyQuote(); 
            updateProgressBar(); 
            manageLessonDisplayAndControls();

            completeLessonButton.addEventListener('click', handleCompleteLesson);
            previousLessonButton.addEventListener('click', handlePreviousLesson); // Evento para o novo botão
            exportProgressButton.addEventListener('click', exportProgress);
            importProgressInput.addEventListener('change', importProgress);
            closeLessonModalButtonEl.addEventListener('click', closeLessonModal); // Evento para fechar o modal

            // Fechar modal com tecla Esc
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !lessonModalEl.classList.contains('hidden')) {
                    closeLessonModal();
                }
            });


            if (IS_DEVELOPMENT_MODE) {
                console.log("Língua Diária rodando em MODO DE DESENVOLVIMENTO.");
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
